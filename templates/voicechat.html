{% extends "profilebase.html" %}
{% block title %}voicechat{% endblock title %}
{% block body %}
<style>
    .toggle-button {
        padding: 10px 20px;
        border: 1px solid #ccc;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
    }

    .toggle-button.active {
        background-color: #8e7fec; 
        background-image: linear-gradient(90deg, #8e7fec, #4939b1 50%, #514886); 
        color: white; 
    }

    /* Style for user messages */
    .user-message {
       width: 60%;
       margin-right: auto; /* Align to right */
        margin-left: 0;
        background-color: #8e7fec;
        color: white;
        text-align: left;
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 10px;
        width: fit-content;
        
    }

    /* Style for bot messages */
    .bot-message {
        background-color: #d9d9d9;
        width: 50%;
        margin-left: 30%;
        margin: auto;
        color: black;
        text-align: justify;
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 10px;
        width: fit-content;
        margin-left: auto; /* Align to right */
        margin-right: 0;
    }
    #messageContainer {
         /* Set maximum height for message container */
        overflow-y: auto; /* Enable vertical scrolling */
        padding: 0.5%; /* Add padding for better appearance */
    }
    .backboll{
        opacity: 0.5;
        z-index: -1;
    }
</style>
<img class="backboll" src="{{url_for('static',filename='backboll.png')}}" alt="backboll" style="margin-bottom: -70%;margin-left: 5%; width: 90%;height: 80%;margin-top: -6%;">
<div style="opacity: 1;">
<center>
    
    <input type="text" id="userInput" style="border: none; background-color: #cfc8c8; opacity: 0.5;width: 57%; text-align: left; height: 2.5rem; border-radius: 100px; margin-bottom:18% ; margin-left: -2%; " placeholder="Any question any time "><br>
    <a href="/voicearticulate">
        <img src="{{ url_for('static', filename='arrow.png') }}" class="img-fluid" alt="arrow" style="width: 2%;height: 3%; margin-left: -90%; margin-top: -55%;">
    </a>
    <div class="box " style="background-color: #635858; width: 70rem; height: 34rem; border-radius: 100px;">
        <div class="minibox border border-black" style="background-color: #d9d9d9;border-radius: 100px 0 0 100px;width: 9rem; height: 34rem;  border-radius: 100px 0 0 100px; margin-top: -30%; margin-left: -88.5%;"></div>
        <a href=""><div  style=" margin-top: -45%; margin-left: -87%; "><h3><i class="fa-solid fa-bars"></i></h3></div></a>
        <a href=""><div  style=" margin-top: 34%;margin-left: -87%;" ><h3><i class="fa-solid fa-gear"></i></h3></div></a>
        <a id="microphone"><img src="{{ url_for('static', filename='mic.png') }}" class="img-fluid" alt="arrow" style="width: 15%;height:29%; margin-top: -1%;"></a>
        <div class="messages border border-white " id="messageContainer" style="width: 80%; height: 75%; margin-top: -50%; margin-left: 12%;"></div>
    </div>
    <div class="selection" style="  margin-top:8%;">
        <a id="stopButton" class="btn btn-outline-danger" style="margin: 2%;margin-right: 1.5%;">Stop Speaking</a>
        <br>
        <h5>Switch to quiz mode for interactive learning.</h5><br>
        <h5 style="font-size: 350;"><b>Quiz Mode</b></h5>
        <button class="toggle-button" style=" border-radius: 100px;">Quiz Mode</button><br><br>
        <h6 style="margin-top: 1%;">Upload your document for a personalized explanation.</h6><br>
        <a href="/upload" type="button" class="btn btn-outline-success" type="submit" style="background: linear-gradient(90deg, #70998f 30.5%, #253330); border: 1px solid black;color: white; border-radius: 20px; width: 200px; height: 40px; ;"><b>Upload</b></a>
        <br><img src="{{ url_for('static', filename='upload.png') }}" class="img-fluid" alt="microphone" style="width: 2.5%;height: 3.6%; margin-top: -29.2%; margin-bottom:-24%; margin-right: 10%;">
        
    </div>
</div>

</center>
</div>
<a id="sendButton" type="button" class="btn btn-outline-success" type="submit" style="margin-bottom: 3%;background-color: #8e7fec; background-image: linear-gradient(90deg, #8e7fec, #4939b1 50%, #514886); color: white; border-radius: 20px; width: 100px; height: 40px;margin-bottom: 71%; margin-top:-73.5%; margin-left: 78%;"><b>Send</b></a>
<a href="/auto_conv" type="button" class="btn btn-outline-light" style="color: rgb(77, 74, 74); border-radius: 20px; width: 200px; height: 40px; margin-left: 42.8%;"><b>Voice Flow</b></a>
<script>
    // Function to stop speaking
    document.getElementById("stopButton").addEventListener("click", function() {
        speechSynthesis.cancel(); // Cancel speech synthesis
    });

    // Toggle button functionality
    const toggleButton = document.querySelector('.toggle-button');
    toggleButton.addEventListener('click', function() {
        this.classList.toggle('active'); // Toggle "active" class on button click
    });

    // Event listener for microphone click
    // document.getElementById("microphone").addEventListener("click", function() {
    //     fetch('/start-speech-recognition')
    //     .then(response => response.text())
    //     .then(data => {
    //         // Update the input field value with the recognized text
    //         document.getElementById("userInput").value = data;
    //         // Speak the recognized text
    //         var speech = new SpeechSynthesisUtterance(data);
    //         speechSynthesis.speak(speech);
    //     })
    //     .catch(error => {
    //         console.error('Error:', error);
    //     });
    // });
    // Event listener for microphone click
// document.getElementById("microphone").addEventListener("click", function() {
//     fetch('/start-speech-recognition')
//     .then(response => response.text())
//     .then(data => {
//         // Update the input field value with the recognized text
//         document.getElementById("userInput").value = data;
//         // Speak only if the recognized text is from the bot
//         if (sender === 'bot') {
//             var speech = new SpeechSynthesisUtterance(data);
//             speechSynthesis.speak(speech);
//         }
//     })
//     .catch(error => {
//         console.error('Error:', error);
//     });
// });

    // Event listener for microphone click
document.getElementById("microphone").addEventListener("click", function() {
    fetch('/start-speech-recognition')
    .then(response => response.text())
    .then(data => {
        // Update the input field value with the recognized text
        document.getElementById("userInput").value = data;
        
        // Remove emojis and special characters
        const sanitizedText = data.replace(/[\u{1F600}-\u{1F6FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}***#]/gu, '');
        
        // Speak only if the recognized text is from the bot
        if (sender === 'bot') {
            var speech = new SpeechSynthesisUtterance(sanitizedText);
            speechSynthesis.speak(speech);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
});



    // Function to send message to backend and append bot response
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const messageContainer = document.getElementById('messageContainer');

    function sendMessageToBackend(message) {
        fetch('/send_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => response.json())
        .then(data => {
            appendMessage(data.message, 'bot');
            // Speak the bot's response
            var speech = new SpeechSynthesisUtterance(data.message);
            speechSynthesis.speak(speech);
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    // Function to append message to message container
    // Function to append message to message container
function appendMessage(message, sender) {
    const sanitizedMessage = message.replace(/\n\n/g, '<br><br>'); // Replace newline characters with <br> tags for paragraphs

    const messageElement = document.createElement('div');
    messageElement.innerHTML = sanitizedMessage;

    // Set class based on sender
    if (sender === 'user') {
        messageElement.classList.add('user-message');
    } else {
        messageElement.classList.add('bot-message');
    }

    messageContainer.appendChild(messageElement);
    messageContainer.scrollTop = messageContainer.scrollHeight;
    userInput.value = ''; // Clear input field
    userInput.focus(); // Return focus to input field
}


    // Event listener for send button click
    sendButton.addEventListener('click', function() {
        const messageText = userInput.value.trim();
        if (messageText !== '') {
            appendMessage(messageText, 'user');
            sendMessageToBackend(messageText);
        }
    });

    // Event listener for Enter key press
    userInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            sendButton.click();
        }
    });
</script>
{% endblock body %}
